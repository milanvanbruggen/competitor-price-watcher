{% extends "base.html" %}

{% block title %}360 Competitor Dashboard{% endblock %}

{% block styles %}
<style>
    .result { margin-top: 20px; }
    .debug-info { 
        margin-top: 20px;
        font-family: monospace;
        white-space: pre-wrap;
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
    }
    .nav-tabs {
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">

    <h2 class="mb-4">Rekenmodules</h2>
    
    <!-- Main navigation tabs -->
    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="sqm-price-tab" data-bs-toggle="tab" data-bs-target="#sqm-price" type="button" role="tab">
                Prijs per m¬≤
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="shipping-tab" data-bs-toggle="tab" data-bs-target="#shipping" type="button" role="tab">
                Verzendkosten
            </button>
        </li>
    </ul>
    
    <!-- Tab content -->
    <div class="tab-content" id="mainTabsContent">
        <!-- Square meter price tab -->
        <div class="tab-pane fade show active" id="sqm-price" role="tabpanel">
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Bereken Prijs</h5>
                            <form id="priceForm">
                                <div class="mb-3">
                                    <label for="url" class="form-label">Product URL</label>
                                    <input type="url" class="form-control" id="url" required>
                                </div>
                                <div class="mb-3">
                                    <label for="dikte" class="form-label">Dikte (mm)</label>
                                    <input type="number" class="form-control" id="dikte" value="2">
                                </div>
                                <div class="mb-3">
                                    <label for="lengte" class="form-label">Lengte (mm)</label>
                                    <input type="number" class="form-control" id="lengte" value="1000">
                                </div>
                                <div class="mb-3">
                                    <label for="breedte" class="form-label">Breedte (mm)</label>
                                    <input type="number" class="form-control" id="breedte" value="1000">
                                </div>
                                <div class="mb-3">
                                    <label for="country" class="form-label">Land</label>
                                    <select class="form-control" id="country">
                                        {% for code, country in countries.items() %}
                                        <option value="{{ code }}"{% if code == 'nl' %} selected{% endif %}>
                                            {{ country.name }} ({{ country.currency_symbol }}, {{ country.vat_rate }}% BTW)
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Bereken</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Resultaat</h5>
                            <div id="result" class="result">
                                <p>Voer een URL in en klik op Bereken om de prijs te zien.</p>
                            </div>
                            <div id="logging" class="logging-info" style="display: none;">
                                <h6>Live Logging:</h6>
                                <div id="logging-content"></div>
                            </div>
                            <div id="debug" class="debug-info" style="display: none;">
                                <h6>Debug Informatie:</h6>
                                <div id="debug-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shipping costs tab -->
        <div class="tab-pane fade" id="shipping" role="tabpanel">
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Bereken Verzendkosten</h5>
                            <form id="shippingForm">
                                <div class="mb-3">
                                    <label for="shipping_url" class="form-label">Product URL</label>
                                    <input type="url" class="form-control" id="shipping_url" required>
                                </div>
                                <div class="mb-3">
                                    <label for="shipping_package" class="form-label">Pakkettype</label>
                                    <select class="form-control" id="shipping_package">
                                        {% for id, package in packages.items() %}
                                        <option value="{{ id }}" title="{{ package.description }}">
                                            {{ package.name }}: {{ package.display }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted package-description"></small>
                                </div>
                                <div class="mb-3">
                                    <label for="shipping_country" class="form-label">Land</label>
                                    <select class="form-control" id="shipping_country">
                                        {% for code, country in countries.items() %}
                                        <option value="{{ code }}"{% if code == 'nl' %} selected{% endif %}>
                                            {{ country.name }} ({{ country.currency_symbol }}, {{ country.vat_rate }}% BTW)
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Bereken Verzendkosten</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Resultaat</h5>
                            <div id="shipping_result" class="result">
                                <p>Voer een URL in en klik op Bereken om de verzendkosten te zien.</p>
                            </div>
                            <div id="shipping_logging" class="logging-info" style="display: none;">
                                <h6>Live Logging:</h6>
                                <div id="shipping_logging_content"></div>
                            </div>
                            <div id="shipping_debug" class="debug-info" style="display: none;">
                                <h6>Debug Informatie:</h6>
                                <div id="shipping_debug_content"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">API Documentatie</h5>
                    <p>Deze applicatie biedt twee REST API endpoints:</p>
                    <h6>1. Prijs per m¬≤ (<code>/api/calculate-smp</code>)</h6>
                    <p>Request Parameters:</p>
                    <ul>
                        <li><code>url</code>: De URL van de productpagina</li>
                        <li><code>dikte</code>: Dikte in mm (default: 2)</li>
                        <li><code>lengte</code>: Lengte in mm (default: 1000)</li>
                        <li><code>breedte</code>: Breedte in mm (default: 1000)</li>
                        <li><code>country</code>: Landcode (default: nl)</li>
                    </ul>

                    <h6>2. Verzendkosten (<code>/api/calculate-shipping</code>)</h6>
                    <p>Request Parameters:</p>
                    <ul>
                        <li><code>url</code>: De URL van de productpagina</li>
                        <li><code>package_type</code>: Type pakket (1-6, default: 1)</li>
                        <li><code>thickness</code>: Optionele dikte in mm (overschrijft pakket dikte)</li>
                        <li><code>country</code>: Landcode (default: nl)</li>
                    </ul>

                    <h6>Response (beide endpoints):</h6>
                    <ul>
                        <li><code>price_excl_vat</code>: Prijs exclusief BTW</li>
                        <li><code>price_incl_vat</code>: Prijs inclusief BTW</li>
                        <li><code>currency</code>: Valuta code (EUR, GBP, etc.)</li>
                        <li><code>currency_symbol</code>: Valuta symbool (‚Ç¨, ¬£, etc.)</li>
                        <li><code>vat_rate</code>: BTW percentage voor het gekozen land</li>
                        <li><code>package_info</code>: (Alleen voor shipping) Informatie over het gekozen pakket:
                            <ul>
                                <li><code>type</code>: Pakket type (1-6)</li>
                                <li><code>name</code>: Naam van het pakket</li>
                                <li><code>description</code>: Beschrijving van het pakket</li>
                                <li><code>quantity</code>: Aantal stuks in het pakket</li>
                                <li><code>dimensions</code>: Afmetingen in mm (lengte x breedte)</li>
                                <li><code>thickness</code>: Gebruikte dikte in mm</li>
                                <li><code>display</code>: Weergave tekst van het pakket</li>
                            </ul>
                        </li>
                        <li><code>error</code>: Eventuele foutmelding (optioneel)</li>
                    </ul>

                    <h6>Voorbeeld Request:</h6>
                    <pre>{
    "url": "https://example.com/product",
    "package_type": 2,
    "thickness": 3,  // optioneel
    "country": "nl"
}</pre>

                    <h6>Voorbeeld Response:</h6>
                    <pre>{
    "status": "success",
    "status_code": 200,
    "message": "Shipping costs calculated successfully",
    "data": {
        "price_excl_vat": 12.40,
        "price_incl_vat": 15.00,
        "currency": "EUR",
        "currency_symbol": "‚Ç¨",
        "vat_rate": 21,
        "package_info": {
            "type": 2,
            "name": "Medium pakket, meerdere stuks",
            "description": "Medium pakket, meerdere stuks",
            "quantity": 5,
            "dimensions": "500x500 mm",
            "thickness": 3,
            "display": "5x 50x50 cm"
        }
    }
}</pre>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let eventSource = null;

    function startStatusStream() {
        // Always close existing connection first
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }

        eventSource = new EventSource('/api/status-stream');
        
        eventSource.addEventListener('status', (event) => {
            const status = JSON.parse(event.data);
            updateStatus(status);
        });

        eventSource.onerror = (error) => {
            console.error('SSE Error:', error);
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        };
    }

    function getStepEmoji(step_type) {
        const emojis = {
            'navigation': 'üåê',
            'loading': '‚åõ',
            'loaded': '‚úÖ',
            'select': 'üîΩ',
            'input': '‚å®Ô∏è',
            'click': 'üñ±Ô∏è',
            'wait': '‚è≥',
            'read_price': 'üí∞',
            'calculation': 'üßÆ',
            'complete': '‚ú®',
            'error': '‚ùå',
            'cleanup': 'üßπ',
            'config': '‚öôÔ∏è'
        };
        return emojis[step_type] || 'üìù';
    }

    function formatStepDetails(status) {
        if (!status.step_details) return '';
        if (status.step_details === null) return '';

        switch (status.step_type) {
            case 'select':
                const selector = status.step_details.selector || '';
                const value = status.step_details.value?.replace('{thickness}', '')
                    .replace('{width}', '')
                    .replace('{length}', '') || '';
                return `${selector} ${value}`;
            case 'input':
                return `${status.step_details.selector} = ${status.step_details.value}`;
            case 'navigation':
                return status.step_details.url;
            case 'complete':
                const excl = status.step_details.price_excl_vat.toFixed(2);
                const incl = status.step_details.price_incl_vat.toFixed(2);
                return `‚Ç¨${excl} (excl) / ‚Ç¨${incl} (incl)`;
            case 'config':
                return `${status.step_details.domain}`;
            default:
                return '';
        }
    }

    function updateStatus(status) {
        // Determine which result div to use based on the active tab
        const isShipping = document.querySelector('#shipping.active') !== null;
        const resultDiv = document.getElementById(isShipping ? 'shipping_result' : 'result');
        const loggingDiv = document.getElementById(isShipping ? 'shipping_logging' : 'logging');
        const loggingContent = document.getElementById(isShipping ? 'shipping_logging_content' : 'logging-content');
        const debugDiv = document.getElementById(isShipping ? 'shipping_debug' : 'debug');
        const debugContent = document.getElementById(isShipping ? 'shipping_debug_content' : 'debug-content');

        // Format timestamp
        const timestamp = new Date(status.timestamp).toLocaleTimeString('nl-NL', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });

        // Update logging information with compact format
        const stepEmoji = getStepEmoji(status.step_type);
        const stepDetails = formatStepDetails(status);
        const logLine = `<div class="status-update">
            <span class="timestamp">${timestamp}</span>
            <span class="step-emoji">${stepEmoji}</span>
            <span class="step-type">${status.step_type}</span>
            ${stepDetails ? `<span class="step-details">${stepDetails}</span>` : ''}
        </div>`;
        
        loggingContent.innerHTML += logLine;
        loggingDiv.style.display = 'block';

        // Ensure we always scroll to the latest activity
        requestAnimationFrame(() => {
            loggingContent.scrollTop = loggingContent.scrollHeight;
        });

        // If it's a complete status, update both result and debug
        if (status.step_type === 'complete' && status.step_details) {
            const priceExclVat = status.step_details.price_excl_vat.toFixed(2);
            const priceInclVat = status.step_details.price_incl_vat.toFixed(2);
            
            if (isShipping) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h4>Berekening voltooid!</h4>
                        <p>Verzendkosten excl. BTW: ‚Ç¨${priceExclVat}</p>
                        <p>Verzendkosten incl. BTW: ‚Ç¨${priceInclVat}</p>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h4>Berekening voltooid!</h4>
                        <p>Prijs excl. BTW: ‚Ç¨${priceExclVat}</p>
                        <p>Prijs incl. BTW: ‚Ç¨${priceInclVat}</p>
                    </div>
                `;
            }

            // Update debug information with final request/response
            debugDiv.style.display = 'block';
            debugContent.innerHTML = `Request:\n${JSON.stringify({
                url: document.getElementById(isShipping ? 'shipping_url' : 'url').value,
                ...(isShipping ? {
                    country: document.getElementById('shipping_country').value,
                    package_type: parseInt(document.getElementById('shipping_package').value)
                } : {
                    dikte: parseFloat(document.getElementById('dikte').value),
                    lengte: parseFloat(document.getElementById('lengte').value),
                    breedte: parseFloat(document.getElementById('breedte').value),
                    country: document.getElementById('country').value
                })
            }, null, 2)}\n\nResponse:\n${JSON.stringify({
                status: "success",
                data: {
                    price_excl_vat: parseFloat(priceExclVat),
                    price_incl_vat: parseFloat(priceInclVat)
                }
            }, null, 2)}`;

            // Close the EventSource connection after completion
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        } else if (status.step_type === 'error') {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h4>Error</h4>
                    <p>${status.message}</p>
                </div>
            `;
            // Update debug with error information
            debugDiv.style.display = 'block';
            debugContent.innerHTML = `Error: ${status.message}`;

            // Close the EventSource connection on error
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        }
    }

    // Existing price calculation form handler
    document.getElementById('priceForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const resultDiv = document.getElementById('result');
        const loggingDiv = document.getElementById('logging');
        const loggingContent = document.getElementById('logging-content');
        const debugDiv = document.getElementById('debug');
        const debugContent = document.getElementById('debug-content');
        
        // Reset display
        resultDiv.innerHTML = '<div class="alert alert-info">Bezig met berekenen...</div>';
        loggingContent.innerHTML = '';
        debugContent.innerHTML = '';
        loggingDiv.style.display = 'block';
        debugDiv.style.display = 'none';
        
        // Start SSE connection
        startStatusStream();
        
        const url = document.getElementById('url').value;
        const dikte = parseFloat(document.getElementById('dikte').value);
        const lengte = parseFloat(document.getElementById('lengte').value);
        const breedte = parseFloat(document.getElementById('breedte').value);
        const country = document.getElementById('country').value;

        try {
            const response = await fetch('/api/calculate-smp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    url,
                    dikte,
                    lengte,
                    breedte,
                    country
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail?.message || error.detail || 'Er is een fout opgetreden');
            }

        } catch (error) {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h4>Error</h4>
                    <p>${error.message}</p>
                </div>
            `;
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        }
    });

    // Update the styling to ensure smooth scrolling
    const style = document.createElement('style');
    style.textContent = `
        .status-update {
            margin-bottom: 4px;
            padding: 2px 0;
            font-family: monospace;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .timestamp {
            color: #666;
            font-size: 0.9em;
        }
        .step-emoji {
            font-size: 1.1em;
        }
        .step-type {
            color: #0066cc;
            font-weight: bold;
            text-transform: capitalize;
            min-width: 80px;
        }
        .step-details {
            color: #444;
        }
        .debug-info, .logging-info {
            margin-top: 12px;
            font-family: monospace;
            white-space: pre-wrap;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .logging-info {
            font-size: 0.9em;
            line-height: 1.2;
        }
        .debug-info h6, .logging-info h6 {
            margin: 0 0 8px 0;
            padding: 0;
            font-size: 0.9em;
            font-weight: bold;
            color: #666;
        }
        #logging-content, #shipping_logging_content,
        #debug-content, #shipping_debug_content {
            margin-top: 8px;
        }
    `;
    document.head.appendChild(style);

    // Shipping form handler
    document.getElementById('shippingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const resultDiv = document.getElementById('shipping_result');
        const loggingDiv = document.getElementById('shipping_logging');
        const loggingContent = document.getElementById('shipping_logging_content');
        const debugDiv = document.getElementById('shipping_debug');
        const debugContent = document.getElementById('shipping_debug_content');
        
        // Reset display
        resultDiv.innerHTML = '<div class="alert alert-info">Bezig met berekenen...</div>';
        loggingContent.innerHTML = '';
        debugContent.innerHTML = '';
        loggingDiv.style.display = 'block';
        debugDiv.style.display = 'none';
        
        // Start SSE connection
        startStatusStream();
        
        const url = document.getElementById('shipping_url').value;
        const country = document.getElementById('shipping_country').value;
        const packageType = parseInt(document.getElementById('shipping_package').value);

        const requestData = {
            url,
            country,
            package_type: packageType
        };
        
        try {
            const response = await fetch('/api/calculate-shipping', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                debugDiv.style.display = 'block';
                debugContent.innerHTML = `Request:\n${JSON.stringify(requestData, null, 2)}\n\nError Response:\n${JSON.stringify(errorData, null, 2)}`;
                throw new Error(errorData.detail?.message || errorData.detail || 'Er is een fout opgetreden');
            }

        } catch (error) {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h4>Error</h4>
                    <p>${error.message}</p>
                </div>
            `;
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        }
    });

    // Add tab change handler to reset logging and debug
    document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-bs-target');
            const isShipping = targetId === '#shipping';
            
            // Reset logging
            const loggingDiv = document.getElementById(isShipping ? 'shipping_logging' : 'logging');
            const loggingContent = document.getElementById(isShipping ? 'shipping_logging_content' : 'logging-content');
            loggingDiv.style.display = 'none';
            loggingContent.innerHTML = '';
            
            // Reset debug
            const debugDiv = document.getElementById(isShipping ? 'shipping_debug' : 'debug');
            const debugContent = document.getElementById(isShipping ? 'shipping_debug_content' : 'debug-content');
            debugDiv.style.display = 'none';
            debugContent.innerHTML = '';
            
            // Reset result
            const resultDiv = document.getElementById(isShipping ? 'shipping_result' : 'result');
            resultDiv.innerHTML = `<p>Voer een URL in en klik op Bereken om de ${isShipping ? 'verzendkosten' : 'prijs'} te zien.</p>`;
        });
    });

    // Add input change handlers to automatically submit the form
    ['dikte', 'lengte', 'breedte', 'country'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => {
            // Only submit if there is already a URL entered
            const url = document.getElementById('url').value;
            if (url) {
                document.getElementById('priceForm').dispatchEvent(new Event('submit'));
            }
        });
    });

    ['shipping_country', 'shipping_package'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => {
            // Only submit if there is already a URL entered
            const url = document.getElementById('shipping_url').value;
            if (url) {
                document.getElementById('shippingForm').dispatchEvent(new Event('submit'));
            }
        });
    });

    // Add package description update handler
    document.getElementById('shipping_package').addEventListener('change', function(e) {
        const option = e.target.options[e.target.selectedIndex];
        const description = option.getAttribute('title');
        document.querySelector('.package-description').textContent = description;
    });

    // Trigger initial package description update without submitting form
    const initialOption = document.getElementById('shipping_package').options[document.getElementById('shipping_package').selectedIndex];
    document.querySelector('.package-description').textContent = initialOption.getAttribute('title');
</script>
{% endblock %} 