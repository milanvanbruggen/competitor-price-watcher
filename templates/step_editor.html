{% extends "base.html" %}

{% block title %}Step Editor{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Step Editor</h2>
        <p class="mt-2 text-gray-600">Create and edit configuration steps with a visual interface.</p>
    </div>

    <!-- Current Configuration Info -->
    <div class="flex justify-between items-center mb-4">
        <div class="flex-1">
            <div id="currentConfigInfo" class="hidden">
                <div class="bg-blue-50 border border-blue-200 rounded-md px-3 py-2">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-circle-info h-4 w-4 text-blue-500"></i>
                        <div class="flex items-center">
                            <span class="text-xs text-blue-900">Currently editing:</span>
                            <span class="text-xs font-medium text-blue-900 ml-1">
                                Domain: <span id="currentDomain" class="font-mono text-xs">-</span>
                                | Category: <span id="currentCategory" class="font-mono text-xs">-</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="ml-4">
            <button id="loadConfigBtn" class="inline-flex items-center justify-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                <i class="fas fa-file-import h-4 w-4 mr-2"></i>
                Load Config
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left side: Step Editor -->
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Steps</h3>
                <div class="flex gap-2">
                    <button id="addStepBtn" class="inline-flex items-center justify-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        <i class="fas fa-plus h-4 w-4 mr-2"></i>
                        Add Step
                    </button>
                    <button id="clearStepsBtn" class="inline-flex items-center justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        <i class="fas fa-trash h-4 w-4 mr-2"></i>
                        Clear All
                    </button>
                </div>
            </div>

            <!-- Step list -->
            <div id="stepList" class="space-y-3">
                <!-- Steps will be added here dynamically -->
            </div>
        </div>

        <!-- Right side: JSON Preview -->
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Configuration Preview</h3>
                <div class="flex gap-2">
                    <button id="copyJsonBtn" class="inline-flex items-center justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        <i class="fas fa-copy h-4 w-4 mr-2"></i>
                        Copy JSON
                    </button>
                    <button id="saveConfigBtn" class="inline-flex items-center justify-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        <i class="fas fa-floppy-disk h-4 w-4 mr-2"></i>
                        Save Configuration
                    </button>
                </div>
            </div>

            <!-- JSON preview -->
            <pre id="jsonPreview" class="bg-gray-50 p-4 rounded-md font-mono text-sm overflow-auto max-h-[calc(100vh-300px)]"></pre>
        </div>
    </div>
</div>

<!-- Add Step Modal -->
<div id="addStepModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 hidden overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md my-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Add Step</h3>
            </div>
            <div class="p-6 max-h-[70vh] overflow-y-auto">
                <form id="addStepForm">
                    <div class="space-y-4">
                        <div>
                            <label for="stepType" class="block text-sm font-medium text-gray-700 mb-1">Step Type</label>
                            <select id="stepType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                <option value="select">Select</option>
                                <option value="input">Input</option>
                                <option value="click">Click</option>
                                <option value="wait">Wait</option>
                                <option value="blur">Blur</option>
                                <option value="modify_element">Modify Element</option>
                                <option value="read_price">Read Price</option>
                            </select>
                        </div>

                        <!-- Dynamic fields will be added here based on step type -->
                        <div id="stepFields"></div>
                    </div>
                </form>
            </div>
            <div class="px-6 py-4 bg-gray-50 rounded-b-lg flex justify-end gap-2 sticky bottom-0">
                <button id="cancelStepBtn" class="inline-flex items-center justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Cancel
                </button>
                <button id="saveStepBtn" class="inline-flex items-center justify-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    <i class="fas fa-plus h-4 w-4 mr-2"></i>
                    Add Step
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Load Configuration Modal -->
<div id="loadConfigModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 hidden overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md my-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Load Configuration</h3>
            </div>
            <div class="p-6 max-h-[70vh] overflow-y-auto">
                <form id="loadConfigForm">
                    <div class="space-y-4">
                        <div>
                            <label for="loadDomain" class="block text-sm font-medium text-gray-700 mb-1">Select Domain</label>
                            <select id="loadDomain" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                <option value="">Select a domain...</option>
                                {% for domain, config in domain_configs.items() %}
                                <option value="{{ domain }}">{{ domain }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="loadCategory" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <select id="loadCategory" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                <option value="square_meter_price">Square Meter Price</option>
                                <option value="shipping">Shipping</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="px-6 py-4 bg-gray-50 rounded-b-lg flex justify-end gap-2 sticky bottom-0">
                <button id="cancelLoadBtn" class="inline-flex items-center justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Cancel
                </button>
                <button id="confirmLoadBtn" class="inline-flex items-center justify-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    <i class="fas fa-file-import h-4 w-4 mr-2"></i>
                    Load
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Save Configuration Modal -->
<div id="saveConfigModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 hidden overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md my-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Save Configuration</h3>
            </div>
            <div class="p-6 max-h-[70vh] overflow-y-auto">
                <form id="saveConfigForm">
                    <div class="space-y-4">
                        <div>
                            <label for="domainName" class="block text-sm font-medium text-gray-700 mb-1">Domain Name</label>
                            <div class="flex gap-2">
                                <select id="existingDomain" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                    <option value="">Create new domain...</option>
                                    {% for domain, config in domain_configs.items() %}
                                    <option value="{{ domain }}">{{ domain }}</option>
                                    {% endfor %}
                                </select>
                                <input type="text" id="domainName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="example.com">
                            </div>
                        </div>
                        <div>
                            <label for="configCategory" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <select id="configCategory" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                <option value="square_meter_price">Square Meter Price</option>
                                <option value="shipping">Shipping</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="px-6 py-4 bg-gray-50 rounded-b-lg flex justify-end gap-2 sticky bottom-0">
                <button id="cancelSaveBtn" class="inline-flex items-center justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Cancel
                </button>
                <button id="confirmSaveBtn" class="inline-flex items-center justify-center rounded-md bg-green-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                    <i class="fas fa-floppy-disk h-4 w-4 mr-2"></i>
                    Save
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Store domain configurations from the server
const domainConfigs = {{ domain_configs | tojson | safe }};

let steps = [];
let editingIndex = -1;

// Step type definitions
const stepFields = {
    select: [
        {
            name: 'select_method',
            label: 'Selectiemethode',
            type: 'radio',
            options: [
                { value: 'selector', label: 'Via CSS selector' },
                { value: 'index', label: 'Via index (positie)' }
            ],
            default: 'selector',
            help: 'Kies hoe je een element wilt selecteren: via een CSS/XPath selector of via de positie (index)'
        },
        {
            name: 'selector',
            label: 'Selector',
            type: 'text',
            required: true,
            help: 'Enter a CSS selector (e.g., #select-id, .class-name) or XPath (e.g., //select[@name="options"])',
            condition: { field: 'select_method', value: 'selector' }
        },
        {
            name: 'select_element',
            label: 'Dropdown Selector',
            type: 'text',
            required: true,
            help: 'CSS selector voor het dropdown element waaruit je wilt selecteren',
            condition: { field: 'select_method', value: 'index' }
        },
        {
            name: 'option_index',
            label: 'Optie index',
            type: 'number',
            required: true,
            min: 0,
            help: 'De index (positie) van de optie die je wilt selecteren (0 = eerste optie)',
            condition: { field: 'select_method', value: 'index' }
        },
        {
            name: 'value',
            label: 'Value',
            type: 'value_with_vars',
            required: true,
            variables: ['thickness', 'width', 'length', 'quantity'],
            help: 'The value to select. You can use variables like {thickness} that will be replaced with actual values',
            condition: { field: 'select_method', value: 'selector' }
        },
        { 
            name: 'unit', 
            type: 'select', 
            label: 'Unit', 
            options: ['mm', 'cm'], 
            required: false,
            help: 'The unit of measurement for the value. Will convert values automatically',
            condition: { field: 'select_method', value: 'selector' }
        },
        { 
            name: 'option_container', 
            type: 'text', 
            label: 'Option Container', 
            required: false,
            help: 'CSS selector for custom dropdown container. Only needed for non-standard dropdowns',
            condition: { field: 'select_method', value: 'selector' }
        },
        { 
            name: 'option_selector', 
            type: 'text', 
            label: 'Option Selector', 
            required: false,
            help: 'CSS selector pattern for options within a custom dropdown. Use {value} as placeholder',
            condition: { field: 'select_method', value: 'selector' }
        }
    ],
    input: [
        {
            name: 'selector',
            label: 'Selector',
            type: 'text',
            required: true,
            help: 'Enter a CSS selector (e.g., #input-id, .class-name) or XPath (e.g., //input[@name="quantity"])'
        },
        {
            name: 'value',
            label: 'Value',
            type: 'value_with_vars',
            required: true,
            variables: ['thickness', 'width', 'length', 'quantity'],
            help: 'The value to input. You can use variables like {thickness} that will be replaced with actual values'
        },
        { 
            name: 'unit', 
            type: 'select', 
            label: 'Unit', 
            options: ['mm', 'cm', 'm', 'mm²', 'cm²', 'm²'], 
            required: false,
            help: 'The unit of measurement for the value. Will convert values automatically'
        },
        { 
            name: 'clear_first', 
            type: 'checkbox', 
            label: 'Clear First', 
            required: false,
            help: 'Whether to clear the input field before entering the new value'
        }
    ],
    click: [
        {
            name: 'selector',
            label: 'Selector',
            type: 'text',
            required: true,
            help: 'Enter a CSS selector (e.g., #button-id, .class-name) or XPath (e.g., //button[contains(text(),"Add")])'
        },
        {
            name: 'description',
            label: 'Description',
            type: 'text',
            required: false,
            help: 'Optional description of what this click is doing'
        }
    ],
    wait: [
        { 
            name: 'duration', 
            type: 'select', 
            label: 'Duration', 
            options: ['short', 'default', 'long', 'longer'], 
            required: true,
            help: 'How long to wait: short (0.5s), default (1s), long (1.5s), longer (3s)'
        }
    ],
    blur: [
        {
            name: 'selector',
            label: 'Selector',
            type: 'text',
            required: true,
            help: 'Enter a CSS selector for the field to blur (unfocus). Used after entering values when needed'
        }
    ],
    modify_element: [
        {
            name: 'selector',
            label: 'Selector',
            type: 'text',
            required: true,
            help: 'Enter a CSS selector for the element to modify'
        },
        {
            name: 'add_class',
            label: 'Add Class',
            type: 'text',
            required: false,
            help: 'Optional: CSS class to add to the element'
        },
        {
            name: 'script',
            label: 'Custom JavaScript',
            type: 'text',
            required: false,
            help: 'Optional: Custom JavaScript to run on the element'
        }
    ],
    read_price: [
        { 
            name: 'selector', 
            type: 'text', 
            label: 'Selector', 
            required: true,
            help: 'Selector for the price element. Can use CSS (#price), XPath (//span[@class="price"]), or text content'
        },
        { 
            name: 'includes_vat', 
            type: 'checkbox', 
            label: 'Includes VAT', 
            required: false,
            help: 'Check if the price shown includes VAT. Will be used for correct price calculations'
        }
    ]
};

// Initialize event listeners
document.addEventListener('DOMContentLoaded', () => {
    // Button event listeners
    document.getElementById('loadConfigBtn').addEventListener('click', showLoadConfigModal);
    document.getElementById('addStepBtn').addEventListener('click', showAddStepModal);
    document.getElementById('clearStepsBtn').addEventListener('click', clearSteps);
    document.getElementById('copyJsonBtn').addEventListener('click', copyJsonToClipboard);
    document.getElementById('saveConfigBtn').addEventListener('click', showSaveConfigModal);
    document.getElementById('cancelStepBtn').addEventListener('click', hideAddStepModal);
    document.getElementById('saveStepBtn').addEventListener('click', saveStep);
    document.getElementById('cancelSaveBtn').addEventListener('click', hideSaveConfigModal);
    document.getElementById('confirmSaveBtn').addEventListener('click', saveConfiguration);
    document.getElementById('cancelLoadBtn').addEventListener('click', hideLoadConfigModal);
    document.getElementById('confirmLoadBtn').addEventListener('click', loadConfiguration);

    // Domain selection handlers
    document.getElementById('existingDomain').addEventListener('change', handleExistingDomainChange);

    // Step type change handler
    document.getElementById('stepType').addEventListener('change', updateStepFields);

    // Initial update
    updateStepFields();
    updateJsonPreview();
    
    // Automatisch alle modals configureren om Enter-toets te ondersteunen
    setupAllModals();
});

// Helper function om Enter-toets te koppelen aan primaire button in modals
function setupModalEnterKey(modalId, primaryButtonIdOrElement) {
    const modal = document.getElementById(modalId);
    let primaryButton;
    
    // Controleer of we een ID of een element hebben gekregen
    if (typeof primaryButtonIdOrElement === 'string') {
        primaryButton = document.getElementById(primaryButtonIdOrElement);
    } else if (primaryButtonIdOrElement instanceof Element) {
        primaryButton = primaryButtonIdOrElement;
    }
    
    if (!modal || !primaryButton) return;
    
    // Verwijder eerst eventuele bestaande handlers
    modal.removeEventListener('keydown', modal._keydownHandler);
    
    // Maak en sla de handler op zodat deze later kan worden verwijderd
    modal._keydownHandler = function(e) {
        if (e.key === 'Enter' && !e.ctrlKey && !e.shiftKey && !e.altKey && !e.metaKey) {
            // Voorkom dat de Enter-toets in textarea's de form submit trigger
            if (e.target.tagName.toLowerCase() === 'textarea') return;
            
            // Voorkom standaard form submit gedrag
            e.preventDefault();
            
            // Trigger klik op de primaire knop
            primaryButton.click();
        }
    };
    
    // Voeg event listener toe
    modal.addEventListener('keydown', modal._keydownHandler);
}

function showAddStepModal() {
    document.getElementById('addStepModal').classList.remove('hidden');
    editingIndex = -1;
    document.getElementById('saveStepBtn').textContent = 'Add Step';
    updateStepFields();
    
    // Koppel Enter-toets aan primaire knop
    setupModalEnterKey('addStepModal', 'saveStepBtn');
}

function hideAddStepModal() {
    document.getElementById('addStepModal').classList.add('hidden');
    document.getElementById('addStepForm').reset();
}

function showSaveConfigModal() {
    document.getElementById('saveConfigModal').classList.remove('hidden');
    
    // Koppel Enter-toets aan primaire knop
    setupModalEnterKey('saveConfigModal', 'confirmSaveBtn');
}

function hideSaveConfigModal() {
    document.getElementById('saveConfigModal').classList.add('hidden');
    document.getElementById('saveConfigForm').reset();
}

function showLoadConfigModal() {
    document.getElementById('loadConfigModal').classList.remove('hidden');
    
    // Koppel Enter-toets aan primaire knop
    setupModalEnterKey('loadConfigModal', 'confirmLoadBtn');
}

function hideLoadConfigModal() {
    document.getElementById('loadConfigModal').classList.add('hidden');
    document.getElementById('loadConfigForm').reset();
}

function handleExistingDomainChange(e) {
    const domainInput = document.getElementById('domainName');
    if (e.target.value) {
        domainInput.value = e.target.value;
        domainInput.disabled = true;
    } else {
        domainInput.value = '';
        domainInput.disabled = false;
    }
}

function updateStepFields() {
    const stepType = document.getElementById('stepType').value;
    const fieldsContainer = document.getElementById('stepFields');
    fieldsContainer.innerHTML = '';
    
    // Map om alle veldwaarden bij te houden voor conditionele velden
    const fieldValues = {};

    // Eerst alle velden verwerken die geen voorwaarde hebben
    stepFields[stepType].filter(field => !field.condition).forEach(field => {
        createField(field, fieldsContainer, fieldValues);
    });
    
    // Als we een select type hebben met radio buttons, zorgen dat de juiste waarde wordt ingesteld
    if (stepType === 'select') {
        // Wacht even totdat de velden zijn gemaakt
        setTimeout(() => {
            // Controleer of we select_method radio buttons hebben
            const selectorRadio = document.getElementById('select_method_selector');
            const indexRadio = document.getElementById('select_method_index');
            
            if (selectorRadio && indexRadio) {
                // Zorg ervoor dat minstens één van de radio buttons is geselecteerd
                if (!selectorRadio.checked && !indexRadio.checked) {
                    selectorRadio.checked = true;
                }
                
                // Update de fieldValues map met de geselecteerde waarde
                fieldValues['select_method'] = selectorRadio.checked ? 'selector' : 'index';
                
                // Verwerk de conditionele velden op basis van de selectie
                updateConditionalFields(stepType, fieldValues);
                
                // Voeg event listeners toe aan de radio buttons
                selectorRadio.addEventListener('change', () => {
                    if (selectorRadio.checked) {
                        fieldValues['select_method'] = 'selector';
                        updateConditionalFields(stepType, fieldValues);
                    }
                });
                
                indexRadio.addEventListener('change', () => {
                    if (indexRadio.checked) {
                        fieldValues['select_method'] = 'index';
                        updateConditionalFields(stepType, fieldValues);
                    }
                });
            }
        }, 50);
    } else {
        // Voor andere types, verwerk conditionele velden meteen
        updateFieldValues(stepType, fieldValues);
        
        // Verwerk conditionele velden op basis van initiële waarden
        stepFields[stepType].filter(field => field.condition).forEach(field => {
            const condition = field.condition;
            const dependentValue = fieldValues[condition.field];
            
            if (dependentValue === condition.value) {
                createField(field, fieldsContainer, fieldValues);
            }
        });
        
        // Voeg event listeners toe aan velden die andere velden beïnvloeden
        stepFields[stepType].filter(field => {
            return stepFields[stepType].some(f => f.condition && f.condition.field === field.name);
        }).forEach(field => {
            const element = document.getElementById(field.name);
            if (!element) return;
            
            if (field.type === 'radio') {
                const radioGroup = document.querySelectorAll(`input[name="${field.name}"]`);
                radioGroup.forEach(radio => {
                    radio.addEventListener('change', () => updateConditionalFields(stepType, fieldValues));
                });
            } else {
                element.addEventListener('change', () => updateConditionalFields(stepType, fieldValues));
            }
        });
    }
}

// Helper functie om conditionele velden bij te werken wanneer afhankelijke velden wijzigen
function updateConditionalFields(stepType, fieldValues) {
    const fieldsContainer = document.getElementById('stepFields');
    
    // Update de waarden map
    updateFieldValues(stepType, fieldValues);
    
    // Alle velden met condities opnieuw evalueren
    stepFields[stepType].filter(field => field.condition).forEach(field => {
        const condition = field.condition;
        const dependentValue = fieldValues[condition.field];
        const existingField = document.querySelector(`.field-container[data-field="${field.name}"]`);
        
        // Controleer of het veld moet worden getoond
        const shouldShow = dependentValue === condition.value;
        
        if (shouldShow) {
            // Toon het veld als het nog niet zichtbaar is
            if (!existingField) {
                createField(field, fieldsContainer, fieldValues);
            }
        } else {
            // Verberg het veld als het zichtbaar is
            if (existingField) {
                existingField.remove();
            }
        }
    });
}

// Helper functie om de huidige waarden van alle velden bij te werken
function updateFieldValues(stepType, fieldValues) {
    stepFields[stepType].forEach(field => {
        if (field.type === 'radio') {
            const selectedRadio = document.querySelector(`input[name="${field.name}"]:checked`);
            if (selectedRadio) {
                fieldValues[field.name] = selectedRadio.value;
            } else {
                fieldValues[field.name] = field.default || '';
            }
        } else {
            const element = document.getElementById(field.name);
            if (element) {
                if (element.type === 'checkbox') {
                    fieldValues[field.name] = element.checked;
                } else {
                    fieldValues[field.name] = element.value;
                }
            }
        }
    });
}

// Helper functie om een enkel veld te maken en toe te voegen aan de container
function createField(field, container, fieldValues) {
    const div = document.createElement('div');
    div.className = 'mb-4 field-container';
    div.dataset.field = field.name;

    const label = document.createElement('label');
    label.className = 'block text-sm font-medium text-gray-700 mb-1';
    label.textContent = field.label;
    
    div.appendChild(label);

    if (field.type === 'radio') {
        const radioContainer = document.createElement('div');
        radioContainer.className = 'mt-1 space-y-2';
        
        field.options.forEach((option, index) => {
            const radioWrap = document.createElement('div');
            radioWrap.className = 'flex items-center';
            
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.id = `${field.name}_${option.value}`;
            radio.name = field.name;
            radio.value = option.value;
            radio.className = 'h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300';
            
            // Stel de default waarde in
            if ((index === 0 && !field.default) || option.value === field.default) {
                radio.checked = true;
                fieldValues[field.name] = option.value;
            }
            
            const radioLabel = document.createElement('label');
            radioLabel.htmlFor = `${field.name}_${option.value}`;
            radioLabel.className = 'ml-2 block text-sm text-gray-700';
            radioLabel.textContent = option.label;
            
            radioWrap.appendChild(radio);
            radioWrap.appendChild(radioLabel);
            radioContainer.appendChild(radioWrap);
        });
        
        div.appendChild(radioContainer);
    } else if (field.type === 'value_with_vars') {
        // Create a container for the value input and variable selector
        const container = document.createElement('div');
        container.className = 'flex gap-2';

        // Create the value input
        const valueInput = document.createElement('input');
        valueInput.type = 'text';
        valueInput.id = field.name;
        valueInput.name = field.name;
        valueInput.className = 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm';
        valueInput.required = field.required;

        // Create the variable selector
        const varSelect = document.createElement('select');
        varSelect.className = 'mt-1 block w-48 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm';
        varSelect.innerHTML = `
            <option value="">Insert variable...</option>
            ${field.variables.map(v => `<option value="{${v}}">{${v}}</option>`).join('')}
        `;
        varSelect.addEventListener('change', function() {
            if (this.value) {
                valueInput.value = this.value;
                fieldValues[field.name] = this.value;
                this.value = ''; // Reset dropdown after selection
            }
        });

        container.appendChild(valueInput);
        container.appendChild(varSelect);
        div.appendChild(container);
    } else if (field.type === 'select') {
        const select = document.createElement('select');
        select.id = field.name;
        select.name = field.name;
        select.className = 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm';
        select.required = field.required;
        
        field.options.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option;
            opt.textContent = option;
            select.appendChild(opt);
        });
        
        div.appendChild(select);
        fieldValues[field.name] = select.value;
    } else if (field.type === 'checkbox') {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = field.name;
        checkbox.name = field.name;
        checkbox.className = 'rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500';
        checkbox.required = field.required;
        
        div.appendChild(checkbox);
        fieldValues[field.name] = checkbox.checked;
    } else if (field.type === 'number') {
        const input = document.createElement('input');
        input.type = 'number';
        input.id = field.name;
        input.name = field.name;
        input.className = 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm';
        input.required = field.required;
        
        if (field.min !== undefined) input.min = field.min;
        if (field.max !== undefined) input.max = field.max;
        if (field.step !== undefined) input.step = field.step;
        
        div.appendChild(input);
        fieldValues[field.name] = input.value;
    } else {
        const input = document.createElement('input');
        input.type = field.type;
        input.id = field.name;
        input.name = field.name;
        input.className = 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm';
        input.required = field.required;
        
        div.appendChild(input);
        fieldValues[field.name] = input.value;
    }

    // Add help text if available
    if (field.help) {
        const helpContainer = document.createElement('div');
        helpContainer.className = 'mt-2 flex items-start gap-1';
        
        const infoIcon = document.createElement('div');
        infoIcon.innerHTML = `<i class="fas fa-circle-info h-3 w-3 text-gray-400 mt-1"></i>`;
        
        const helpText = document.createElement('p');
        helpText.className = 'text-xs text-gray-500 flex-1';
        helpText.textContent = field.help;
        
        helpContainer.appendChild(infoIcon);
        helpContainer.appendChild(helpText);
        div.appendChild(helpContainer);
    }

    container.appendChild(div);
}

function saveStep() {
    const form = document.getElementById('addStepForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const stepType = document.getElementById('stepType').value;
    const step = { type: stepType };
    
    // Eerst alle zichtbare velden vinden
    const visibleFields = document.querySelectorAll('.field-container');
    const visibleFieldNames = Array.from(visibleFields).map(el => el.dataset.field);
    
    // Verzamel alle waarden van relevante velden
    stepFields[stepType].forEach(field => {
        // Controleer of dit veld zichtbaar is, behalve voor radio buttons (die hebben een speciale behandeling nodig)
        if (!visibleFieldNames.includes(field.name) && field.type !== 'radio') {
            return;
        }
        
        // Voor radio buttons, haal de geselecteerde waarde op
        if (field.type === 'radio') {
            const selectedRadio = document.querySelector(`input[name="${field.name}"]:checked`);
            if (selectedRadio) {
                step[field.name] = selectedRadio.value;
            } else if (field.default) {
                step[field.name] = field.default;
            }
            return;
        }
        
        const element = document.getElementById(field.name);
        if (!element) return;
        
        if (element.type === 'checkbox') {
            step[field.name] = element.checked;
        } else {
            const value = element.value.trim();
            if (value) {
                step[field.name] = value;
            }
        }
    });
    
    // Speciale verwerking voor index-gebaseerde select (voor backward compatibility met bestaande implementatie)
    if (stepType === 'select' && step.select_method === 'index') {
        // Markeer expliciet dat dit een index-gebaseerde selectie is
        step.use_index = true;
        
        // Rename voor samenhang
        if (step.select_element) {
            step.selector = step.select_element;
            delete step.select_element;
        }
        
        // Zorg ervoor dat option_index altijd aanwezig is en een string/nummer is
        if (!step.option_index) {
            step.option_index = "0";
        }
        
        // Voor index-gebaseerde selectie gebruiken we een speciale waarde die niet als getal wordt geïnterpreteerd
        // We formatteren het als 'index:{nummer}' zodat de backend het speciaal kan behandelen
        step.value = `index:${step.option_index}`;
        
        // Deze velden zijn niet nodig voor index-gebaseerde selectie
        delete step.unit;
        delete step.option_container;
        delete step.option_selector;
    }
    
    // Verwijder de select_method uit het uiteindelijke step object omdat dit alleen UI-gerelateerd is
    delete step.select_method;

    // Sla op of de stap wordt bewerkt of nieuw is voordat de modal wordt verborgen
    const isEditing = editingIndex >= 0;
    
    if (isEditing) {
        // Vervang de bestaande stap op dezelfde positie
        steps[editingIndex] = step;
    } else {
        // Voeg een nieuwe stap toe
        steps.push(step);
    }

    // Verberg de modal (deze reset de form maar niet de editingIndex)
    hideAddStepModal();
    
    // Reset de editingIndex expliciet na het opslaan
    editingIndex = -1;
    
    updateStepList();
    updateJsonPreview();
}

function updateStepList() {
    const container = document.getElementById('stepList');
    container.innerHTML = '';

    steps.forEach((step, index) => {
        const stepElement = document.createElement('div');
        stepElement.className = 'bg-gray-50 p-4 rounded-lg flex items-center justify-between cursor-move';
        stepElement.draggable = true;
        stepElement.dataset.index = index;

        // Add drag event listeners
        stepElement.addEventListener('dragstart', handleDragStart);
        stepElement.addEventListener('dragend', handleDragEnd);
        stepElement.addEventListener('dragover', handleDragOver);
        stepElement.addEventListener('drop', handleDrop);
        
        // Add visual handle for dragging
        const dragHandle = document.createElement('div');
        dragHandle.className = 'flex-shrink-0 mr-3 text-gray-400';
        dragHandle.innerHTML = `<i class="fas fa-grip-vertical w-4 h-4"></i>`;

        const stepInfo = document.createElement('div');
        stepInfo.className = 'flex-1';
        
        const stepTitle = document.createElement('h4');
        stepTitle.className = 'font-medium text-gray-900 capitalize';
        stepTitle.textContent = step.type;
        
        const stepDetails = document.createElement('p');
        stepDetails.className = 'text-sm text-gray-500 mt-1';
        stepDetails.textContent = formatStepDetails(step);

        stepInfo.appendChild(stepTitle);
        stepInfo.appendChild(stepDetails);

        const actions = document.createElement('div');
        actions.className = 'flex gap-2 ml-4';

        const editBtn = document.createElement('button');
        editBtn.className = 'text-blue-600 hover:text-blue-800';
        editBtn.innerHTML = `<i class="fas fa-pencil-alt h-5 w-5"></i>`;
        editBtn.onclick = () => editStep(index);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'text-red-600 hover:text-red-800';
        deleteBtn.innerHTML = `<i class="fas fa-trash h-5 w-5"></i>`;
        deleteBtn.onclick = () => deleteStep(index);

        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);

        stepElement.appendChild(dragHandle);
        stepElement.appendChild(stepInfo);
        stepElement.appendChild(actions);
        container.appendChild(stepElement);
    });
}

// Drag and drop handlers
let draggedItem = null;

function handleDragStart(e) {
    draggedItem = this;
    this.classList.add('opacity-50');
    
    // Add visual feedback to other items
    document.querySelectorAll('#stepList > div').forEach(item => {
        if (item !== draggedItem) {
            item.classList.add('border-2', 'border-dashed', 'border-transparent');
        }
    });
}

function handleDragEnd(e) {
    this.classList.remove('opacity-50');
    
    // Remove visual feedback from all items
    document.querySelectorAll('#stepList > div').forEach(item => {
        item.classList.remove('border-2', 'border-dashed', 'border-transparent', 'border-blue-300');
    });
    
    draggedItem = null;
}

function handleDragOver(e) {
    e.preventDefault();
    
    // Add visual feedback only to the current target
    document.querySelectorAll('#stepList > div').forEach(item => {
        if (item === this && item !== draggedItem) {
            item.classList.add('border-2', 'border-dashed', 'border-blue-300');
        } else {
            item.classList.remove('border-blue-300');
        }
    });
}

function handleDrop(e) {
    e.preventDefault();
    
    if (draggedItem && this !== draggedItem) {
        const fromIndex = parseInt(draggedItem.dataset.index);
        const toIndex = parseInt(this.dataset.index);
        
        // Reorder the steps array
        const [movedStep] = steps.splice(fromIndex, 1);
        steps.splice(toIndex, 0, movedStep);
        
        // Update the UI
        updateStepList();
        updateJsonPreview();
    }
}

function formatStepDetails(step) {
    const details = [];
    
    // Voor index-gebaseerde select stappen, toon speciale informatie
    if (step.type === 'select' && step.use_index) {
        details.push(`Dropdown: ${step.selector}`);
        details.push(`Index: ${step.option_index}`);
    } else {
        // Standaard details voor alle andere stappen
        if (step.selector) details.push(`Selector: ${step.selector}`);
        if (step.value) details.push(`Value: ${step.value}`);
        if (step.duration) details.push(`Duration: ${step.duration}`);
        if (step.description) details.push(step.description);
    }
    
    return details.join(' | ') || 'No additional details';
}

function editStep(index) {
    editingIndex = index;
    const step = steps[index];
    
    // Toon de modal zonder showAddStepModal te gebruiken om te voorkomen dat editingIndex wordt gereset
    document.getElementById('addStepModal').classList.remove('hidden');
    
    // Zet de step type in de dropdown
    document.getElementById('stepType').value = step.type;
    
    // Voor index-gebaseerde select steps, zet select_method op 'index'
    if (step.type === 'select' && step.use_index) {
        // We moeten eerst velden genereren zodat radio buttons bestaan
        updateStepFields();
        
        // Selecteer de 'index' radio button
        const indexRadio = document.getElementById('select_method_index');
        if (indexRadio) {
            indexRadio.checked = true;
            
            // Trigger een change event om conditionele velden bij te werken
            const event = new Event('change');
            indexRadio.dispatchEvent(event);
        }
        
        // Wacht even tot de UI is bijgewerkt
        setTimeout(() => {
            // Vul de velden voor index-gebaseerde selectie
            const selectElement = document.getElementById('select_element');
            if (selectElement) {
                selectElement.value = step.selector || '';
            }
            
            const optionIndex = document.getElementById('option_index');
            if (optionIndex) {
                optionIndex.value = step.option_index || 0;
            }
            
            document.getElementById('saveStepBtn').textContent = 'Update Step';
            
            // Koppel Enter-toets aan primaire knop
            setupModalEnterKey('addStepModal', 'saveStepBtn');
        }, 100);
    } else if (step.type === 'select') {
        // Voor reguliere select steps, zet select_method op 'selector'
        updateStepFields();
        
        // Selecteer de 'selector' radio button
        const selectorRadio = document.getElementById('select_method_selector');
        if (selectorRadio) {
            selectorRadio.checked = true;
            
            // Trigger een change event om conditionele velden bij te werken
            const event = new Event('change');
            selectorRadio.dispatchEvent(event);
        }
        
        // Wait for the fields to be created and updated
        setTimeout(() => {
            // Vul de velden voor de stap
            stepFields[step.type].forEach(field => {
                // Skip de radio buttons, die zijn hierboven al ingesteld
                if (field.type === 'radio') return;
                
                // Voor conditionele velden, controleer of ze bij de huidige select_method horen
                if (field.condition && field.condition.field === 'select_method' && field.condition.value !== 'selector') {
                    return;
                }
                
                const element = document.getElementById(field.name);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = step[field.name] || false;
                    } else {
                        element.value = step[field.name] || '';
                    }
                }
            });

            document.getElementById('saveStepBtn').textContent = 'Update Step';
            
            // Koppel Enter-toets aan primaire knop
            setupModalEnterKey('addStepModal', 'saveStepBtn');
        }, 100);
    } else {
        // Voor andere stap types, normale verwerking
        updateStepFields();
    
        // Wait for the fields to be created
        setTimeout(() => {
            // Fill in the fields
            stepFields[step.type].forEach(field => {
                const element = document.getElementById(field.name);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = step[field.name] || false;
                    } else {
                        element.value = step[field.name] || '';
                    }
                }
            });

            document.getElementById('saveStepBtn').textContent = 'Update Step';
            
            // Koppel Enter-toets aan primaire knop
            setupModalEnterKey('addStepModal', 'saveStepBtn');
        }, 100);
    }
}

function deleteStep(index) {
    if (confirm('Are you sure you want to delete this step?')) {
        steps.splice(index, 1);
        updateStepList();
        updateJsonPreview();
    }
}

function clearSteps() {
    if (confirm('Are you sure you want to clear all steps?')) {
        steps = [];
        // Reset current configuration info
        document.getElementById('currentConfigInfo').classList.add('hidden');
        document.getElementById('currentDomain').textContent = '-';
        document.getElementById('currentCategory').textContent = '-';
        updateStepList();
        updateJsonPreview();
    }
}

function updateJsonPreview() {
    const config = {
        steps: steps
    };
    document.getElementById('jsonPreview').textContent = JSON.stringify(config, null, 2);
}

function copyJsonToClipboard() {
    const jsonText = document.getElementById('jsonPreview').textContent;
    navigator.clipboard.writeText(jsonText).then(() => {
        alert('Configuration copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy text: ', err);
    });
}

async function loadConfiguration() {
    const domain = document.getElementById('loadDomain').value;
    const category = document.getElementById('loadCategory').value;

    if (!domain) {
        alert('Please select a domain');
        return;
    }

    const config = domainConfigs[domain];
    if (!config || !config.categories || !config.categories[category]) {
        alert(`No ${category} configuration found for ${domain}`);
        return;
    }

    // Update current configuration info
    document.getElementById('currentConfigInfo').classList.remove('hidden');
    document.getElementById('currentDomain').textContent = domain;
    document.getElementById('currentCategory').textContent = category;

    steps = config.categories[category].steps || [];
    updateStepList();
    updateJsonPreview();
    hideLoadConfigModal();
}

async function saveConfiguration() {
    const existingDomain = document.getElementById('existingDomain').value;
    const newDomain = document.getElementById('domainName').value.trim();
    const domain = existingDomain || newDomain;
    const category = document.getElementById('configCategory').value;

    if (!domain) {
        alert('Please enter a domain name');
        return;
    }

    // If saving to an existing domain, ask for confirmation
    if (existingDomain && !confirm(`Are you sure you want to update the existing configuration for ${existingDomain}?`)) {
        return;
    }

    const config = {
        domain: domain,
        categories: {
            [category]: {
                steps: steps
            }
        }
    };

    // If updating existing domain, merge with existing categories
    if (existingDomain && domainConfigs[existingDomain]) {
        const existingConfig = domainConfigs[existingDomain];
        config.categories = {
            ...existingConfig.categories,
            [category]: {
                steps: steps
            }
        };
    }

    try {
        const response = await fetch('/api/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                domain: domain,
                config: config
            })
        });

        const result = await response.json();
        if (result.success) {
            alert('Configuration saved successfully!');
            hideSaveConfigModal();
            // Redirect to config page after successful save
            window.location.href = '/config';
        } else {
            throw new Error(result.error || 'Failed to save configuration');
        }
    } catch (error) {
        alert(`Error saving configuration: ${error.message}`);
    }
}

// Automatisch alle modals configureren om Enter-toets te ondersteunen
function setupAllModals() {
    // Verzamel alle modals in de applicatie
    const modals = document.querySelectorAll('div[id$="Modal"]');
    
    modals.forEach(modal => {
        const modalId = modal.id;
        
        // Zoek de primaire knop in deze modal (meestal de blauwe button)
        // We kijken eerst naar een .btn-primary of bg-blue klasse, dan naar een knop met een blauwe achtergrond
        // of als fallback de laatste knop in de footer (meestal de bevestigingsknop)
        const modalButtons = modal.querySelectorAll('button');
        let primaryButton = null;
        
        // Zoek eerst een knop met primary of blue class
        for (const button of modalButtons) {
            if (button.classList.contains('btn-primary') || 
                button.classList.contains('bg-blue-600') || 
                button.classList.contains('bg-blue-700')) {
                primaryButton = button;
                break;
            }
        }
        
        // Als fallback, neem de laatste knop in de footer als primaire knop
        if (!primaryButton && modalButtons.length > 0) {
            // Check voor knoppen in de footer area (meestal onderaan)
            const footerButtons = modal.querySelectorAll('.px-6.py-4.bg-gray-50 button');
            if (footerButtons.length > 0) {
                primaryButton = footerButtons[footerButtons.length - 1];
            } else {
                // Als laatste optie, neem gewoon de laatste knop
                primaryButton = modalButtons[modalButtons.length - 1];
            }
        }
        
        if (primaryButton) {
            // Stel de enter-toets in voor deze modal met de gevonden primaire knop
            setupModalEnterKey(modalId, primaryButton);
        }
    });
}
</script>
{% endblock %} 