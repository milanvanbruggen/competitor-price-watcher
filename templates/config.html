{% extends "base.html" %}

{% block title %}360 Competitor Dashboard - Configuration{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900 flex items-center">
            Domain Configurations
            <span class="text-base font-normal text-gray-500 ml-2">({{ domain_configs|length }} domains)</span>
        </h2>
    </div>
    
    <div class="flex items-center gap-4 mb-6">
        <div class="flex gap-4 flex-grow">
            <button class="inline-flex justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" onclick="newDomainConfig()">Add New Domain</button>
            <button class="inline-flex justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" onclick="showImportModal()">Import Configuration</button>
        </div>
        <div class="w-72">
            <input type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" id="domainSearch" placeholder="Search domains..." onkeyup="filterDomains()">
        </div>
    </div>
    
    <div class="space-y-2" id="domainAccordion">
        {% for domain, config in domain_configs.items() %}
        <div class="bg-white shadow rounded-lg overflow-hidden domain-item" data-domain="{{ domain }}">
            <div class="border-b border-gray-200">
                <button class="w-full px-4 py-3 text-left hover:bg-gray-50 focus:outline-none flex justify-between items-center" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                    <span class="font-medium text-gray-900">{{ domain }}</span>
                    <svg class="h-5 w-5 text-gray-500 transform transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
            </div>
            <div id="collapse{{ loop.index }}" class="hidden">
                <div class="p-4">
                    <textarea class="w-full h-72 font-mono text-sm bg-gray-50 p-4 rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500" id="domain_{{ domain }}">{{ config | tojson(indent=2) }}</textarea>
                    <div class="mt-4 flex gap-2">
                        <button class="inline-flex justify-center rounded-md border border-transparent bg-green-600 px-4 py-2 text-sm font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" onclick="saveDomainConfig('{{ domain }}')">Save</button>
                        <button class="inline-flex justify-center rounded-md border border-transparent bg-red-600 px-4 py-2 text-sm font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2" onclick="deleteDomainConfig('{{ domain }}')">Delete</button>
                        <button class="inline-flex justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" onclick="exportDomainConfig('{{ domain }}')">Export</button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <h2 class="text-2xl font-bold text-gray-900 mt-8 mb-6">Country Configurations</h2>
    <button class="inline-flex justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 mb-6" onclick="newCountryConfig()">Add New Country</button>
    
    <div class="space-y-2" id="countryAccordion">
        {% for country, config in country_configs.items() %}
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="border-b border-gray-200">
                <button class="w-full px-4 py-3 text-left hover:bg-gray-50 focus:outline-none flex justify-between items-center" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCountry{{ loop.index }}">
                    <span class="font-medium text-gray-900">{{ country }} ({{ config.name }})</span>
                    <svg class="h-5 w-5 text-gray-500 transform transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
            </div>
            <div id="collapseCountry{{ loop.index }}" class="hidden">
                <div class="p-4">
                    <textarea class="w-full h-72 font-mono text-sm bg-gray-50 p-4 rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500" id="country_{{ country }}">{{ config | tojson(indent=2) }}</textarea>
                    <div class="mt-4 flex gap-2">
                        <button class="inline-flex justify-center rounded-md border border-transparent bg-green-600 px-4 py-2 text-sm font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" onclick="saveCountryConfig('{{ country }}')">Save</button>
                        <button class="inline-flex justify-center rounded-md border border-transparent bg-red-600 px-4 py-2 text-sm font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2" onclick="deleteCountryConfig('{{ country }}')">Delete</button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <h2 class="text-2xl font-bold text-gray-900 mt-8 mb-6">Package Configurations</h2>
    <button class="inline-flex justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 mb-6" onclick="newPackageConfig()">Add New Package</button>
    
    <div class="space-y-2" id="packageAccordion">
        {% for id, config in package_configs.items() %}
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="border-b border-gray-200">
                <button class="w-full px-4 py-3 text-left hover:bg-gray-50 focus:outline-none flex justify-between items-center" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePackage{{ loop.index }}">
                    <span class="font-medium text-gray-900">{{ config.name }} ({{ config.display }})</span>
                    <svg class="h-5 w-5 text-gray-500 transform transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
            </div>
            <div id="collapsePackage{{ loop.index }}" class="hidden">
                <div class="p-4">
                    <textarea class="w-full h-72 font-mono text-sm bg-gray-50 p-4 rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500" id="package_{{ id }}">{{ config | tojson(indent=2) }}</textarea>
                    <div class="mt-4 flex gap-2">
                        <button class="inline-flex justify-center rounded-md border border-transparent bg-green-600 px-4 py-2 text-sm font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" onclick="savePackageConfig('{{ id }}')">Save</button>
                        <button class="inline-flex justify-center rounded-md border border-transparent bg-red-600 px-4 py-2 text-sm font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2" onclick="deletePackageConfig('{{ id }}')">Delete</button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- New Domain Modal -->
<div class="fixed inset-0 bg-gray-500 bg-opacity-75 hidden" id="newDomainModal">
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">New Domain Configuration</h3>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label for="newDomainName" class="block text-sm font-medium text-gray-700 mb-1">Domain Name</label>
                    <input type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" id="newDomainName" placeholder="example.com">
                </div>
                <div class="mb-4">
                    <label for="newDomainConfig" class="block text-sm font-medium text-gray-700 mb-1">Configuration</label>
                    <textarea class="w-full h-72 font-mono text-sm bg-gray-50 p-4 rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500" id="newDomainConfig"></textarea>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 rounded-b-lg flex justify-end gap-2">
                <button class="inline-flex justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" onclick="hideModal('newDomainModal')">Cancel</button>
                <button class="inline-flex justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" onclick="createDomainConfig()">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- New Country Modal -->
<div class="fixed inset-0 bg-gray-500 bg-opacity-75 hidden" id="newCountryModal">
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">New Country Configuration</h3>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label for="newCountryCode" class="block text-sm font-medium text-gray-700 mb-1">Country Code</label>
                    <input type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" id="newCountryCode" placeholder="fr">
                </div>
                <div class="mb-4">
                    <label for="newCountryConfig" class="block text-sm font-medium text-gray-700 mb-1">Configuration</label>
                    <textarea class="w-full h-72 font-mono text-sm bg-gray-50 p-4 rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500" id="newCountryConfig"></textarea>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 rounded-b-lg flex justify-end gap-2">
                <button class="inline-flex justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" onclick="hideModal('newCountryModal')">Cancel</button>
                <button class="inline-flex justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" onclick="createCountryConfig()">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Config Modal -->
<div class="fixed inset-0 bg-gray-500 bg-opacity-75 hidden" id="importConfigModal">
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Import Configuration</h3>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label for="importFile" class="block text-sm font-medium text-gray-700 mb-1">Configuration File</label>
                    <input type="file" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" id="importFile" accept=".json">
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 rounded-b-lg flex justify-end gap-2">
                <button class="inline-flex justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" onclick="hideModal('importConfigModal')">Cancel</button>
                <button class="inline-flex justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" onclick="importConfig()">Import</button>
            </div>
        </div>
    </div>
</div>

<!-- New Package Modal -->
<div class="fixed inset-0 bg-gray-500 bg-opacity-75 hidden" id="newPackageModal">
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">New Package Configuration</h3>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label for="newPackageId" class="block text-sm font-medium text-gray-700 mb-1">Package ID</label>
                    <input type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" id="newPackageId" placeholder="7">
                </div>
                <div class="mb-4">
                    <label for="newPackageConfig" class="block text-sm font-medium text-gray-700 mb-1">Configuration</label>
                    <textarea class="w-full h-72 font-mono text-sm bg-gray-50 p-4 rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500" id="newPackageConfig"></textarea>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 rounded-b-lg flex justify-end gap-2">
                <button class="inline-flex justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" onclick="hideModal('newPackageModal')">Cancel</button>
                <button class="inline-flex justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" onclick="createPackageConfig()">Create</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Modal functions
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('hidden');
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('hidden');
    }
}

// Domain configuration functions
function newDomainConfig() {
    showModal('newDomainModal');
    const defaultConfig = {
        "domain": "",
        "categories": {
            "square_meter_price": {
                "steps": [
                    {
                        "type": "select",
                        "selector": "",
                        "value": "{thickness}",
                        "unit": "mm"
                    },
                    {
                        "type": "input",
                        "selector": "",
                        "value": "{width}",
                        "unit": "mm"
                    },
                    {
                        "type": "wait",
                        "duration": "default"
                    },
                    {
                        "type": "input",
                        "selector": "",
                        "value": "{length}",
                        "unit": "mm"
                    }
                ]
            }
        }
    };
    document.getElementById('newDomainConfig').value = JSON.stringify(defaultConfig, null, 2);
}

function showImportModal() {
    showModal('importConfigModal');
    document.getElementById('importFile').value = '';
}

async function saveDomainConfig(domain) {
    try {
        const configElement = document.getElementById(`domain_${domain}`);
        if (!configElement) {
            throw new Error(`Could not find configuration for domain ${domain}`);
        }

        const config = JSON.parse(configElement.value);
        const response = await fetch('/api/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                domain: domain,
                config: config
            })
        });

        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error || 'Failed to save configuration');
        }

        alert('Configuration saved successfully');
        location.reload();
    } catch (error) {
        alert(`Error saving configuration: ${error.message}`);
    }
}

async function createDomainConfig() {
    try {
        const domain = document.getElementById('newDomainName').value.trim();
        if (!domain) {
            throw new Error('Domain name is required');
        }

        const configText = document.getElementById('newDomainConfig').value;
        const config = JSON.parse(configText);
        config.domain = domain;  // Ensure domain is set in config

        const response = await fetch('/api/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                domain: domain,
                config: config
            })
        });

        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error || 'Failed to create configuration');
        }

        hideModal('newDomainModal');
        alert('Configuration created successfully');
        location.reload();
    } catch (error) {
        alert(`Error creating configuration: ${error.message}`);
    }
}

async function deleteDomainConfig(domain) {
    if (!confirm(`Are you sure you want to delete the configuration for ${domain}?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/config/${domain}`, {
            method: 'DELETE'
        });

        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error || 'Failed to delete configuration');
        }

        alert('Configuration deleted successfully');
        location.reload();
    } catch (error) {
        alert(`Error deleting configuration: ${error.message}`);
    }
}

// Country configuration functions
function newCountryConfig() {
    const defaultConfig = {
        "name": "",
        "currency": "EUR",
        "currency_symbol": "€",
        "vat_rate": 21
    };
    document.getElementById('newCountryConfig').value = JSON.stringify(defaultConfig, null, 2);
}

async function saveCountryConfig(country) {
    try {
        const configElement = document.getElementById(`country_${country}`);
        if (!configElement) {
            throw new Error(`Could not find configuration for country ${country}`);
        }

        const config = JSON.parse(configElement.value);
        const response = await fetch('/api/country', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                country: country,
                config: config
            })
        });

        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error || 'Failed to save configuration');
        }

        alert('Configuration saved successfully');
        location.reload();
    } catch (error) {
        alert(`Error saving configuration: ${error.message}`);
    }
}

async function createCountryConfig() {
    try {
        const country = document.getElementById('newCountryCode').value.trim();
        if (!country) {
            throw new Error('Country code is required');
        }

        const configText = document.getElementById('newCountryConfig').value;
        const config = JSON.parse(configText);

        const response = await fetch('/api/country', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                country: country,
                config: config
            })
        });

        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error || 'Failed to create configuration');
        }

        hideModal('newCountryModal');
        alert('Configuration created successfully');
        location.reload();
    } catch (error) {
        alert(`Error creating configuration: ${error.message}`);
    }
}

async function deleteCountryConfig(country) {
    if (!confirm(`Are you sure you want to delete the configuration for ${country}?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/country/${country}`, {
            method: 'DELETE'
        });

        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error || 'Failed to delete configuration');
        }

        alert('Configuration deleted successfully');
        location.reload();
    } catch (error) {
        alert(`Error deleting configuration: ${error.message}`);
    }
}

// Package configuration functions
function newPackageConfig() {
    const defaultConfig = {
        "name": "",
        "description": "",
        "display": "",
        "length": 0,
        "width": 0,
        "thickness": 0,
        "quantity": 1
    };
    document.getElementById('newPackageConfig').value = JSON.stringify(defaultConfig, null, 2);
}

async function savePackageConfig(id) {
    try {
        const configElement = document.getElementById(`package_${id}`);
        if (!configElement) {
            throw new Error(`Could not find configuration for package ${id}`);
        }

        const config = JSON.parse(configElement.value);
        const response = await fetch('/api/packages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                package_id: id,
                config: config
            })
        });

        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error || 'Failed to save configuration');
        }

        alert('Configuration saved successfully');
        location.reload();
    } catch (error) {
        alert(`Error saving configuration: ${error.message}`);
    }
}

async function createPackageConfig() {
    try {
        const id = document.getElementById('newPackageId').value.trim();
        if (!id) {
            throw new Error('Package ID is required');
        }

        const configText = document.getElementById('newPackageConfig').value;
        const config = JSON.parse(configText);

        const response = await fetch('/api/packages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                package_id: id,
                config: config
            })
        });

        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error || 'Failed to create configuration');
        }

        hideModal('newPackageModal');
        alert('Configuration created successfully');
        location.reload();
    } catch (error) {
        alert(`Error creating configuration: ${error.message}`);
    }
}

async function deletePackageConfig(id) {
    if (!confirm(`Are you sure you want to delete the configuration for package ${id}?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/packages/${id}`, {
            method: 'DELETE'
        });

        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error || 'Failed to delete configuration');
        }

        alert('Configuration deleted successfully');
        location.reload();
    } catch (error) {
        alert(`Error deleting configuration: ${error.message}`);
    }
}

// Import/Export functions
function exportDomainConfig(domain) {
    try {
        const configElement = document.getElementById(`domain_${domain}`);
        if (!configElement) {
            throw new Error(`Could not find configuration for domain ${domain}`);
        }

        const config = JSON.parse(configElement.value);
        const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${domain}_config.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    } catch (error) {
        alert(`Error exporting configuration: ${error.message}`);
    }
}

async function importConfig() {
    try {
        const fileInput = document.getElementById('importFile');
        const file = fileInput.files[0];
        if (!file) {
            throw new Error('Please select a file to import');
        }

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const config = JSON.parse(e.target.result);
                if (!config.domain) {
                    throw new Error('Configuration file must contain a domain field');
                }

                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        domain: config.domain,
                        config: config
                    })
                });

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'Failed to import configuration');
                }

                hideModal('importConfigModal');
                alert('Configuration imported successfully');
                location.reload();
            } catch (error) {
                alert(`Error importing configuration: ${error.message}`);
            }
        };
        reader.readAsText(file);
    } catch (error) {
        alert(`Error importing configuration: ${error.message}`);
    }
}

// Toggle accordion items
document.addEventListener('DOMContentLoaded', function() {
    const accordionButtons = document.querySelectorAll('[data-bs-toggle="collapse"]');
    accordionButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-bs-target');
            const targetElement = document.querySelector(targetId);
            if (targetElement) {
                targetElement.classList.toggle('hidden');
                const icon = this.querySelector('svg');
                if (icon) {
                    icon.style.transform = targetElement.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
                }
            }
        });
    });
});

// Domain search functionality
function filterDomains() {
    const searchInput = document.getElementById('domainSearch');
    const searchTerm = searchInput.value.toLowerCase();
    const domainItems = document.querySelectorAll('.domain-item');

    domainItems.forEach(item => {
        const domain = item.getAttribute('data-domain').toLowerCase();
        if (domain.includes(searchTerm)) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
}

// Status stream handling
let eventSource = null;

function startStatusStream() {
    // Always close existing connection first
    if (eventSource) {
        eventSource.close();
        eventSource = null;
    }

    eventSource = new EventSource('/api/status-stream');
    
    eventSource.addEventListener('status', (event) => {
        const status = JSON.parse(event.data);
        updateStatus(status);
    });

    eventSource.onerror = (error) => {
        console.error('SSE Error:', error);
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }
    };
}

function getStepEmoji(step_type) {
    const emojis = {
        'navigation': '→',
        'loading': '⋯',
        'loaded': '✓',
        'select': '▼',
        'input': '⌥',
        'click': '⊙',
        'wait': '◌',
        'read_price': '€',
        'calculation': '∑',
        'complete': '★',
        'error': '×',
        'cleanup': '⌫',
        'config': '⚙'
    };
    return emojis[step_type] || '•';
}

function formatStepDetails(status) {
    if (!status.step_details) return '';
    if (status.step_details === null) return '';

    switch (status.step_type) {
        case 'select':
            const selector = status.step_details.selector || '';
            const value = status.step_details.value?.replace('{thickness}', '')
                .replace('{width}', '')
                .replace('{length}', '') || '';
            return `${selector} ${value}`;
        case 'input':
            return `${status.step_details.selector} = ${status.step_details.value}`;
        case 'navigation':
            return status.step_details.url;
        case 'complete':
            const excl = status.step_details.price_excl_vat.toFixed(2);
            const incl = status.step_details.price_incl_vat.toFixed(2);
            return `€${excl} (excl) / €${incl} (incl)`;
        case 'config':
            return `${status.step_details.domain}`;
        case 'click':
            return status.step_details.selector || '';
        default:
            return '';
    }
}

function updateStatus(status) {
    // Format timestamp
    const timestamp = new Date(status.timestamp).toLocaleTimeString('nl-NL', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });

    // Update logging information with compact format
    const stepEmoji = getStepEmoji(status.step_type);
    const stepDetails = formatStepDetails(status);
    const logLine = `<div class="status-update">
        <span class="timestamp">${timestamp}</span>
        <span class="step-emoji" data-type="${status.step_type}">${stepEmoji}</span>
        <span class="step-type">${status.step_type}</span>
        ${stepDetails ? `<span class="step-details">${stepDetails}</span>` : ''}
    </div>`;
    
    // Add log line to all logging divs
    const loggingDivs = document.querySelectorAll('.logging-info');
    loggingDivs.forEach(div => {
        const content = div.querySelector('[id$="_content"]');
        if (content) {
            content.innerHTML += logLine;
            // Ensure we always scroll to the latest activity
            requestAnimationFrame(() => {
                setTimeout(() => {
                    content.scrollTop = content.scrollHeight;
                }, 0);
            });
        }
    });

    // If it's a complete or error status, close the EventSource connection
    if (status.step_type === 'complete' || status.step_type === 'error') {
        if (eventSource) {
            const es = eventSource;
            eventSource = null;
            setTimeout(() => {
                es.close();
            }, 100);
        }
    }
}
</script>
{% endblock %} 