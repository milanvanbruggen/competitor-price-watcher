{% extends "base.html" %}

{% block title %}Competitor Pricing Scraper - Configuration{% endblock %}

{% block styles %}
<style>
    .config-form {
        max-width: 800px;
        margin: 20px auto;
    }
    .json-editor {
        font-family: monospace;
        height: 300px;
        width: 100%;
        margin-top: 10px;
    }
    .editor-buttons {
        margin-top: 10px;
    }
    .editor-buttons button {
        margin-right: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Domain Configurations</h2>
    <button class="btn btn-primary mb-3" onclick="newDomainConfig()">Add New Domain</button>
    
    <div class="accordion" id="domainAccordion">
        {% for domain, config in domain_configs.items() %}
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                    {{ domain }}
                </button>
            </h2>
            <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#domainAccordion">
                <div class="accordion-body">
                    <textarea class="json-editor" id="domain_{{ domain }}">{{ config | tojson(indent=2) }}</textarea>
                    <div class="editor-buttons">
                        <button class="btn btn-success" onclick="saveDomainConfig('{{ domain }}')">Save</button>
                        <button class="btn btn-danger" onclick="deleteDomainConfig('{{ domain }}')">Delete</button>
                        <button class="btn btn-info" onclick="exportDomainConfig('{{ domain }}')">Export</button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <h2 class="mt-4">Country Configurations</h2>
    <button class="btn btn-primary mb-3" onclick="newCountryConfig()">Add New Country</button>
    
    <div class="accordion" id="countryAccordion">
        {% for country, config in country_configs.items() %}
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCountry{{ loop.index }}">
                    {{ country }} ({{ config.name }})
                </button>
            </h2>
            <div id="collapseCountry{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#countryAccordion">
                <div class="accordion-body">
                    <textarea class="json-editor" id="country_{{ country }}">{{ config | tojson(indent=2) }}</textarea>
                    <div class="editor-buttons">
                        <button class="btn btn-success" onclick="saveCountryConfig('{{ country }}')">Save</button>
                        <button class="btn btn-danger" onclick="deleteCountryConfig('{{ country }}')">Delete</button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- New Domain Modal -->
<div class="modal fade" id="newDomainModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New Domain Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newDomainName" class="form-label">Domain Name</label>
                    <input type="text" class="form-control" id="newDomainName" placeholder="example.com">
                </div>
                <div class="mb-3">
                    <label for="newDomainConfig" class="form-label">Configuration</label>
                    <textarea class="json-editor" id="newDomainConfig"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createDomainConfig()">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- New Country Modal -->
<div class="modal fade" id="newCountryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New Country Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newCountryCode" class="form-label">Country Code</label>
                    <input type="text" class="form-control" id="newCountryCode" placeholder="fr">
                </div>
                <div class="mb-3">
                    <label for="newCountryConfig" class="form-label">Configuration</label>
                    <textarea class="json-editor" id="newCountryConfig"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createCountryConfig()">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Config Modal -->
<div class="modal fade" id="importConfigModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="importFile" class="form-label">Configuration File</label>
                    <input type="file" class="form-control" id="importFile" accept=".json">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="importConfig()">Import</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Domain configuration functions
async function saveDomainConfig(domain) {
    try {
        const textarea = document.getElementById(`domain_${domain}`);
        const config = JSON.parse(textarea.value);
        
        const response = await fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                domain: domain,
                config: config
            })
        });
        
        if (response.ok) {
            alert('Configuration saved successfully!');
            location.reload();
        } else {
            alert('Error saving configuration');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function deleteDomainConfig(domain) {
    if (!confirm(`Are you sure you want to delete the configuration for ${domain}?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/config/${domain}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('Configuration deleted successfully!');
            location.reload();
        } else {
            alert('Error deleting configuration');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function newDomainConfig() {
    document.getElementById('newDomainName').value = '';
    document.getElementById('newDomainConfig').value = JSON.stringify({
        "domain": "",
        "steps": [
            {
                "type": "select",
                "selector": "",
                "value": "{thickness}",
                "unit": "mm"
            },
            {
                "type": "input",
                "selector": "",
                "value": "{width}",
                "unit": "mm"
            },
            {
                "type": "wait",
                "duration": 1000
            },
            {
                "type": "input",
                "selector": "",
                "value": "{length}",
                "unit": "mm"
            },
            {
                "type": "wait",
                "duration": 1000
            },
            {
                "type": "read_price",
                "selector": "",
                "includes_vat": false
            }
        ]
    }, null, 2);
    
    new bootstrap.Modal(document.getElementById('newDomainModal')).show();
}

async function createDomainConfig() {
    try {
        const domain = document.getElementById('newDomainName').value;
        const config = JSON.parse(document.getElementById('newDomainConfig').value);
        
        const response = await fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                domain: domain,
                config: config
            })
        });
        
        if (response.ok) {
            alert('Configuration created successfully!');
            location.reload();
        } else {
            alert('Error creating configuration');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Country configuration functions
async function saveCountryConfig(country) {
    try {
        const textarea = document.getElementById(`country_${country}`);
        const config = JSON.parse(textarea.value);
        
        const response = await fetch('/api/country', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                country: country,
                config: config
            })
        });
        
        if (response.ok) {
            alert('Configuration saved successfully!');
            location.reload();
        } else {
            alert('Error saving configuration');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function deleteCountryConfig(country) {
    if (!confirm(`Are you sure you want to delete the configuration for ${country}?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/country/${country}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('Configuration deleted successfully!');
            location.reload();
        } else {
            alert('Error deleting configuration');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function newCountryConfig() {
    document.getElementById('newCountryCode').value = '';
    document.getElementById('newCountryConfig').value = JSON.stringify({
        "name": "",
        "currency": "EUR",
        "currency_symbol": "€",
        "vat_rate": 21
    }, null, 2);
    
    new bootstrap.Modal(document.getElementById('newCountryModal')).show();
}

async function createCountryConfig() {
    try {
        const country = document.getElementById('newCountryCode').value;
        const config = JSON.parse(document.getElementById('newCountryConfig').value);
        
        const response = await fetch('/api/country', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                country: country,
                config: config
            })
        });
        
        if (response.ok) {
            alert('Configuration created successfully!');
            location.reload();
        } else {
            alert('Error creating configuration');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function exportDomainConfig(domain) {
    try {
        const textarea = document.getElementById(`domain_${domain}`);
        const config = JSON.parse(textarea.value);
        const exportData = {
            domain: domain,
            config: config
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${domain}_config.json`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    } catch (error) {
        alert('Error exporting configuration: ' + error.message);
    }
}

// Add import button to the top of the page
document.addEventListener('DOMContentLoaded', function() {
    const importButton = document.createElement('button');
    importButton.className = 'btn btn-secondary mb-3 ms-2';
    importButton.textContent = 'Import Configuration';
    importButton.onclick = () => new bootstrap.Modal(document.getElementById('importConfigModal')).show();
    
    const addNewDomainButton = document.querySelector('button[onclick="newDomainConfig()"]');
    addNewDomainButton.parentNode.insertBefore(importButton, addNewDomainButton.nextSibling);
});

async function importConfig() {
    try {
        const fileInput = document.getElementById('importFile');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('Please select a file to import');
            return;
        }

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const importData = JSON.parse(e.target.result);
                
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        domain: importData.domain,
                        config: importData.config
                    })
                });
                
                if (response.ok) {
                    alert('Configuration imported successfully!');
                    location.reload();
                } else {
                    alert('Error importing configuration');
                }
            } catch (error) {
                alert('Error parsing import file: ' + error.message);
            }
        };
        reader.readAsText(file);
    } catch (error) {
        alert('Error importing configuration: ' + error.message);
    }
}
</script>
{% endblock %} 